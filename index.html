<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insider Game Online</title>
    <style>
        body { font-family: 'Kanit', sans-serif; text-align: center; background: #2c3e50; color: white; padding: 20px; }
        .container { max-width: 400px; margin: auto; background: #34495e; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        input { width: 80%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
        button { width: 85%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; }
        button:hover { background: #d35400; }
        .card { background: #ecf0f1; color: #2c3e50; padding: 20px; border-radius: 10px; margin-top: 20px; }
        #word-box { font-size: 24px; color: #c0392b; font-weight: bold; }
        ul { list-style: none; padding: 0; text-align: left; }
        li { background: #2980b9; margin: 5px 0; padding: 8px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>INSIDER GAME</h1>

    <div id="setup-area">
        <input type="text" id="playerName" placeholder="ใส่ชื่อของคุณ">
        <button onclick="joinGame()">เข้าสู่ห้องนั่งเล่น</button>
    </div>

    <div id="lobby-area" style="display:none;">
        <h3>ผู้เล่นในห้อง:</h3>
        <ul id="player-list"></ul>
        <p>รอเพื่อนให้ครบ (4-10 คน)</p>
        <button id="start-btn" onclick="masterStartGame()">เริ่มสุ่มบทบาท (Host เท่านั้น)</button>
        <button onclick="clearAllPlayers()">ล้างห้อง</button>
    </div>

    <div id="game-area" style="display:none;">
        <div class="card">
            <h2>คุณคือ: <span id="my-role">กำลังโหลด...</span></h2>
            <div id="word-display" style="display:none;">
                <p>คำศัพท์ลับคือ:</p>
                <div id="word-box"></div>
            </div>
            <p id="hint-text"></p>
        </div>
        <button onclick="resetGame()" style="background: #27ae60;">เริ่มรอบใหม่ (Back to Lobby)</button>
        <button onclick="location.reload()">จบเกม / กลับหน้าแรก</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // --- คัดลอก firebaseConfig จากหน้าจอของคุณมาวางทับตรงนี้ ---
    const firebaseConfig = {
        apiKey: "AIzaSyAQDEhlQwRejSdEiUT6XKd_rpcZcjkgzw8",
        authDomain: "insider-card-game.firebaseapp.com",
        databaseURL: "https://insider-card-game-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "insider-card-game",
        storageBucket: "insider-card-game.firebasestorage.app",
        messagingSenderId: "586011166032",
        appId: "1:586011166032:web:ceafcc3317c30a53435855",
        measurementId: "G-ZR7SP3J1E5"
    };
    // ---------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = "";

    // 1. ฟังก์ชันจอยเกม
    window.joinGame = function() {
        let inputName = document.getElementById('playerName').value;
        myName = inputName.replace(/[\s.#$/[\]]/g, ""); 
        
        if(!myName) return alert("กรุณาใส่ชื่อ (ห้ามมีช่องว่างหรือสัญลักษณ์)");
        
        set(ref(db, 'gameRoom/players/' + myName), { name: inputName, role: 'Waiting' });
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('lobby-area').style.display = 'block';
    };

    window.resetGame = async function() {
        if(confirm("ต้องการเริ่มรอบใหม่สำหรับทุกคนใช่ไหม?")) {
            try {
                // เปลี่ยนสถานะเป็น Waiting แต่ยังไม่ลบ CurrentWord เพื่อเอาไว้เช็คกันซ้ำรอบหน้า
                await set(ref(db, 'gameRoom/status'), "WAITING");
            } catch (error) {
                console.error("Reset failed:", error);
            }
        }
    };

    window.clearAllPlayers = function() {
        if(confirm("ต้องการลบรายชื่อผู้เล่นทุกคนเพื่อเริ่มใหม่ใช่ไหม?")) {
            set(ref(db, 'gameRoom/players'), null).then(() => {
                set(ref(db, 'gameRoom/currentWord'), ""); // ล้างคำศัพท์ด้วยเมื่อล้างห้อง
                alert("ล้างรายชื่อเรียบร้อยแล้ว ทุกคนต้องเข้าห้องใหม่ครับ");
            });
        }
    };

    // 2. อัปเดตรายชื่อคนในห้องแบบ Real-time
    onValue(ref(db, 'gameRoom/players'), (snapshot) => {
        const players = snapshot.val();
        const list = document.getElementById('player-list');
        list.innerHTML = "";
        if(players) {
            Object.values(players).forEach(p => {
                let li = document.createElement('li');
                li.innerText = p.name;
                list.appendChild(li);
            });
        }
    });

    // 3. ฟังก์ชันสุ่ม (แก้ไขใหม่: เพิ่มคำศัพท์ + กันคำซ้ำ)
    window.masterStartGame = async function() {
        // ดึงข้อมูลทั้งห้องมาก่อน เพื่อดูทั้งผู้เล่น และ คำศัพท์เก่า
        const snapshot = await get(ref(db, 'gameRoom'));
        const roomData = snapshot.val();
        
        if (!roomData || !roomData.players) return alert("ไม่มีผู้เล่นในห้อง");
        
        const players = roomData.players;
        const names = Object.keys(players);
        const previousWord = roomData.currentWord || ""; // คำศัพท์รอบที่แล้ว
        
        if (names.length < 2) return alert("ต้องมีอย่างน้อย 2 คน");

        // --- เพิ่มรายการคำศัพท์ตรงนี้ ---
        const words = [
            // หมวดของใช้ทั่วไป
            "จักรยาน", "ดาวหาง", "ภูเขาไฟ", "ตู้เย็น", "ร่ม", "เตารีด", "นาฬิกาทราย",
            "เครื่องซักผ้า", "ไมโครเวฟ", "กล้องถ่ายรูป", "หูฟัง", "กระติกน้ำร้อน",
            "แว่นกันแดด", "แปรงสีฟัน", "หม้อหุงข้าว", "โทรทัศน์", "โคมไฟ",
            "น้ำตก", "ทะเลทราย", "สนามบิน", "ห้องสมุด", "สวนสนุก",
            "ถ้ำสะท้อนแสง", "สถานีอวกาศ", "พิพิธภัณฑ์", "ป่าชายเลน", "ห้างสรรพสินค้า",
            
            // หมวดสัตว์ (ใหม่)
            "สิงโต", "จิงโจ้", "เพนกวิน", "ช้าง", "งูหลาม", "แมงมุม", "วาฬสีน้ำเงิน",
            "ยีราฟ", "ฮิปโป", "นกแก้ว", "เต่าทะเล", "กระรอก", "ม้าน้ำ", "กิ้งก่า",
            
            // หมวดอาหาร (ใหม่)
            "ต้มยำกุ้ง", "พิซซ่า", "ซูชิ", "แฮมเบอร์เกอร์", "ข้าวเหนียวมะม่วง",
            "ส้มตำ", "ทุเรียน", "ไอศกรีม", "ขนมครก", "ผัดไทย", "ชานมไข่มุก",
            "ครัวซองต์", "ไก่ทอด", "หมูกระทะ"
        ];

        // --- Logic สุ่มแบบไม่ซ้ำ ---
        let selectedWord;
        
        // กรองคำศัพท์: เอาคำเก่าออกจากรายการสุ่ม (ถ้ามี)
        const availableWords = words.filter(w => w !== previousWord);

        // สุ่มจากรายการที่กรองแล้ว
        selectedWord = availableWords[Math.floor(Math.random() * availableWords.length)];
        
        console.log(`Previous: ${previousWord}, New: ${selectedWord}`); // เช็คใน Console ได้

        // 1. สุ่มลำดับชื่อ
        const shuffled = names.sort(() => 0.5 - Math.random());
        
        // 2. วนลูปอัปเดตบทบาท
        for (let i = 0; i < shuffled.length; i++) {
            let role = "Normal";
            if (i === 0) role = "Host";
            if (i === 1) role = "Insider";
            
            await set(ref(db, `gameRoom/players/${shuffled[i]}/role`), role);
        }
        
        // 3. อัปเดตคำศัพท์และสถานะเริ่มเกม
        await set(ref(db, 'gameRoom/currentWord'), selectedWord);
        await set(ref(db, 'gameRoom/status'), "START");
    };

    // 4. คอยดูสถานะเกม
    onValue(ref(db, 'gameRoom'), (snapshot) => {
        const data = snapshot.val();
        if(!data) return;

        if(data.status === "START") {
            const myData = data.players[myName];
            if(myData) {
                document.getElementById('lobby-area').style.display = 'none';
                document.getElementById('game-area').style.display = 'block';
                document.getElementById('my-role').innerText = myData.role;
                
                if(myData.role === "Host" || myData.role === "Insider") {
                    document.getElementById('word-display').style.display = 'block';
                    document.getElementById('word-box').innerText = data.currentWord;
                } else {
                    document.getElementById('word-display').style.display = 'none';
                }
            }
        } 
        else if(data.status === "WAITING" || !data.status) {
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('lobby-area').style.display = 'block';
            
            document.getElementById('my-role').innerText = "กำลังรอสุ่ม...";
            document.getElementById('word-box').innerText = "";
            document.getElementById('word-display').style.display = 'none';
        }
    });
</script>
</body>
</html>
